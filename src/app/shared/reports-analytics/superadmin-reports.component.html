<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-20 text-center">
      <h2 class="text-primary mb-2">
        <i class="fas fa-chart-bar me-2"></i>SuperAdmin Reports
      </h2>
      <p class="text-muted">System-wide analytics and comprehensive statistics</p>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="row">
    <div class="col-12 text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading reports...</p>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="row mb-4">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ errorMessage }}
      </div>
    </div>
  </div>

  <!-- Reports Content -->
  <div *ngIf="reports && !isLoading">
    <!-- System Overview Cards -->
    <div class="d-flex flex-wrap gap-3 mb-5">
      <div class="card flex-fill" style="min-width: 200px; max-width: 250px;">
        <div class="card h-100 border-success border-start border-4">
          <div class="card-body d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-graduation-cap fa-2x text-primary mb-3"></i>
            <h3 class="h2 fw-bold mb-1">{{ reports.totalStudents }}</h3>
            <p class="text-muted mb-0">Total Students</p>
          </div>
        </div>
        
      </div>
    
      <div class="card flex-fill" style="min-width: 200px; max-width: 250px;">
        <div class="card h-100 border-success border-start border-4">
          <div class="card-body d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-book fa-2x text-success mb-3"></i>
            <h3 class="h2 fw-bold mb-1">{{ reports.totalCourses }}</h3>
            <p class="text-muted mb-0">Total Courses</p>
          </div>
        </div>
      </div>
    
      <div class="card flex-fill" style="min-width: 200px; max-width: 250px;">
        <div class="card h-100 border-warning border-start border-4">
          <div class="card-body d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-chalkboard-teacher fa-2x text-warning mb-3"></i>
            <h3 class="h2 fw-bold mb-1">{{ reports.totalInstructors }}</h3>
            <p class="text-muted mb-0">Total Instructors</p>
          </div>
        </div>
      </div>
    
      <div class="card flex-fill" style="min-width: 200px; max-width: 250px;">
        <div class="card h-100 border-info border-start border-4">
          <div class="card-body d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-users-cog fa-2x text-info mb-3"></i>
            <h3 class="h2 fw-bold mb-1">{{ reports.totalAdmins }}</h3>
            <p class="text-muted mb-0">Total Admins</p>
          </div>
        </div>
      </div>
    
      <div class="card flex-fill" style="min-width: 200px; max-width: 250px;">
        <div class="card h-100 border-success border-start border-4">
          <div class="card-body d-flex flex-column align-items-center justify-content-center">
            <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
            <h3 class="h2 fw-bold mb-1">{{ getCompletedStudentsCount() }}</h3>
            <p class="text-muted mb-0">Students Completed</p>
            <small class="text-muted">Based on course completion logs</small>
          </div>
        </div>
      </div>
    </div>
    

    <!-- Filter Section -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="courseFilter" class="form-label fw-semibold">Filter by Course:</label>
                <select id="courseFilter" class="form-select" [(ngModel)]="selectedCourseId" (ngModelChange)="onCourseFilterChange()">
                  <option value="">All Courses</option>
                  <option *ngFor="let course of reports.courseEnrollmentStats" [value]="course.courseId">
                    {{ course.courseTitle }}
                  </option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="completionFilter" class="form-label fw-semibold">Completion Status:</label>
                <select id="completionFilter" class="form-select" [(ngModel)]="completionFilter" (ngModelChange)="applyFilters()">
                  <option value="all">All</option>
                  <option value="high">High Completion (>80%)</option>
                  <option value="medium">Medium Completion (50-80%)</option>
                  <option value="low">Low Completion (<50%)</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Course Completion Statistics -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="mb-0 text-primary">
          <i class="fas fa-trophy me-2"></i>Course Completion Statistics
        </h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Course</th>
                <th>Total Enrollments</th>
                <th>Completed Students</th>
                <th>Completion Rate</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let course of filteredCompletionStats">
                <td>
                  <div>
                    <strong class="text-dark">{{ course.courseTitle }}</strong><br>
                    <small class="text-muted">ID: {{ course.courseId }}</small>
                  </div>
                </td>
                <td>
                  <span class="badge bg-primary">{{ getEnrollmentsForCourse(course.courseId) }}</span>
                </td>
                <td>
                  <span class="badge bg-success">{{ getCompletedStudentsForCourse(course.courseId) }}</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="progress me-3" style="width: 100px; height: 10px;">
                      <div class="progress-bar" 
                           [class.bg-danger]="getCompletionRateForCourse(course.courseId) < 40"
                           [class.bg-warning]="getCompletionRateForCourse(course.courseId) >= 40 && getCompletionRateForCourse(course.courseId) < 70"
                           [class.bg-success]="getCompletionRateForCourse(course.courseId) >= 70"
                           [style.width.%]="getCompletionRateForCourse(course.courseId)">
                      </div>
                    </div>
                    <small class="fw-bold">{{ getCompletionRateForCourse(course.courseId) | number:'1.1-1' }}%</small>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Instructor Statistics -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="mb-0 text-primary">
          <i class="fas fa-chalkboard-teacher me-2"></i>Instructor Statistics
        </h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Instructor Name</th>
                <th>Email</th>
                <th>Assigned Courses</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let instructor of instructorStats">
                <td>
                  <div>
                    <strong class="text-dark">{{ instructor.instructorName }}</strong><br>
                    <small class="text-muted">ID: {{ instructor.instructorId }}</small>
                  </div>
                </td>
                <td>{{ instructor.instructorEmail }}</td>
                <td>
                  <span class="badge bg-info">{{ instructor.assignedCourses }}</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Course Details -->
    <div class="card">
      <div class="card-header">
        <h3 class="mb-0 text-primary">
          <i class="fas fa-book-open me-2"></i>Course Details
        </h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>Course Name</th>
                <th>Instructor</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let course of courseDetails">
                <td>
                  <div>
                    <strong class="text-dark">{{ course.title }}</strong><br>
                    <small class="text-muted">ID: {{ course.courseId }}</small>
                  </div>
                </td>
                <td>{{ course.instructorName }}</td>
                <td>
                  <button class="btn btn-outline-primary btn-sm" (click)="viewCourseDetails(course.courseId)">
                    <i class="fas fa-eye me-1"></i>View Details
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Course Details Modal -->
<div class="modal fade" [class.show]="showCourseModal" [style.display]="showCourseModal ? 'block' : 'none'" tabindex="-1" *ngIf="showCourseModal">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-info-circle me-2"></i>Course Details: {{ selectedCourseForModal?.title }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeCourseModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedCourseForModal && courseModalData">
        <!-- Course Information -->
        <div class="mb-4">
          <h6 class="text-primary border-bottom pb-2 mb-3">
            <i class="fas fa-book me-2"></i>Course Information
          </h6>
          <div class="row g-3">
            <div class="col-12">
              <strong>Description:</strong>
              <p class="text-muted">{{ selectedCourseForModal.description || 'No description available' }}</p>
            </div>
            <div class="col-md-6" *ngIf="selectedCourseForModal.prerequisites">
              <strong>Prerequisites:</strong>
              <p class="text-muted">{{ selectedCourseForModal.prerequisites }}</p>
            </div>
            <div class="col-md-6">
              <strong>Created:</strong>
              <p class="text-muted">{{ selectedCourseForModal.createdAt | date:'medium' }}</p>
            </div>
          </div>
        </div>

        <!-- Course Materials -->
        <div class="mb-4" *ngIf="courseModalData.materials?.length > 0">
          <h6 class="text-primary border-bottom pb-2 mb-3">
            <i class="fas fa-folder me-2"></i>Course Materials ({{ courseModalData.materials.length }})
          </h6>
          <div class="list-group">
            <div class="list-group-item d-flex justify-content-between align-items-center" 
                 *ngFor="let material of courseModalData.materials; let i = index">
              <div class="d-flex align-items-center">
                <span class="badge bg-primary rounded-pill me-3">{{ i + 1 }}</span>
                <div>
                  <h6 class="mb-1">{{ material.title }}</h6>
                  <small class="text-muted">Type: {{ material.type || 'Document' }}</small><br>
                  <small class="text-muted">Uploaded: {{ material.uploadedAt | date:'short' }}</small>
                </div>
              </div>
              <div class="btn-group">
                <button class="btn btn-outline-primary btn-sm" (click)="viewMaterial(material)">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-outline-secondary btn-sm" (click)="downloadMaterial(material)">
                  <i class="fas fa-download"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Course Quizzes -->
        <div class="mb-4" *ngIf="courseModalData.quizzes?.length > 0">
          <h6 class="text-primary border-bottom pb-2 mb-3">
            <i class="fas fa-clipboard-question me-2"></i>Quizzes ({{ courseModalData.quizzes.length }})
          </h6>
          <div class="list-group">
            <div class="list-group-item" *ngFor="let quiz of courseModalData.quizzes; let i = index">
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                  <span class="badge bg-success rounded-pill me-3">{{ i + 1 }}</span>
                  <div>
                    <h6 class="mb-1">{{ quiz.title }}</h6>
                    <div class="d-flex gap-3 text-muted small">
                      <span><i class="fas fa-star me-1"></i>{{ quiz.totalMarks }} marks</span>
                      <span><i class="fas fa-list me-1"></i>{{ quiz.questionCount || 0 }} questions</span>
                      <span><i class="fas fa-calendar me-1"></i>{{ quiz.createdAt | date:'short' }}</span>
                    </div>
                  </div>
                </div>
                <button class="btn btn-outline-success btn-sm" (click)="viewQuiz(quiz)">
                  <i class="fas fa-eye me-1"></i>View Quiz
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="text-center py-4" *ngIf="courseModalData.materials?.length === 0 && courseModalData.quizzes?.length === 0">
          <i class="fas fa-box-open text-muted" style="font-size: 3rem;"></i>
          <h6 class="mt-3 text-muted">No Content Available</h6>
          <p class="text-muted">This course doesn't have any materials or quizzes yet.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quiz View Modal -->
<div class="modal fade" [class.show]="showQuizViewModal" [style.display]="showQuizViewModal ? 'block' : 'none'" tabindex="-1" *ngIf="showQuizViewModal">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="fas fa-clipboard-question me-2"></i>Quiz Details: {{ selectedQuizForView?.title }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeQuizViewModal()"></button>
      </div>
      <div class="modal-body">
        <!-- Loading State -->
        <div *ngIf="quizLoading" class="text-center py-4">
          <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3 text-muted">Loading quiz details...</p>
        </div>

        <!-- Quiz Content -->
        <div *ngIf="!quizLoading && selectedQuizForView">
          <!-- Quiz Info -->
          <div class="row g-3 mb-4 p-3 bg-light rounded">
            <div class="col-md-4">
              <strong class="text-uppercase small">Total Questions:</strong>
              <p class="mb-0 h5">{{ selectedQuizQuestions.length }}</p>
            </div>
            <div class="col-md-4">
              <strong class="text-uppercase small">Total Marks:</strong>
              <p class="mb-0 h5">{{ selectedQuizForView.totalMarks }}</p>
            </div>
            <div class="col-md-4">
              <strong class="text-uppercase small">Created:</strong>
              <p class="mb-0">{{ selectedQuizForView.createdAt | date:'medium' }}</p>
            </div>
          </div>

          <!-- Questions List -->
          <div *ngIf="selectedQuizQuestions.length > 0">
            <h6 class="text-success border-bottom pb-2 mb-3">
              <i class="fas fa-list me-2"></i>Questions
            </h6>
            <div class="accordion" id="questionsAccordion">
              <div class="accordion-item mb-3" *ngFor="let question of selectedQuizQuestions; let i = index">
                <h2 class="accordion-header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                          [attr.data-bs-target]="'#question' + i">
                    <div class="d-flex justify-content-between w-100 me-3">
                      <span>{{ i + 1 }}. {{ question.questionText }}</span>
                      <span class="badge bg-success ms-2">[{{ question.marks }} marks]</span>
                    </div>
                  </button>
                </h2>
                <div [id]="'question' + i" class="accordion-collapse collapse" 
                     [attr.data-bs-parent]="'#questionsAccordion'">
                  <div class="accordion-body">
                    <div class="row g-2">
                      <div class="col-md-6">
                        <div class="p-2 rounded" [class.bg-success-subtle]="question.correctOption === 'A'">
                          <strong>A)</strong> {{ question.optionA }}
                          <i *ngIf="question.correctOption === 'A'" class="fas fa-check-circle text-success float-end"></i>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="p-2 rounded" [class.bg-success-subtle]="question.correctOption === 'B'">
                          <strong>B)</strong> {{ question.optionB }}
                          <i *ngIf="question.correctOption === 'B'" class="fas fa-check-circle text-success float-end"></i>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="p-2 rounded" [class.bg-success-subtle]="question.correctOption === 'C'">
                          <strong>C)</strong> {{ question.optionC }}
                          <i *ngIf="question.correctOption === 'C'" class="fas fa-check-circle text-success float-end"></i>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="p-2 rounded" [class.bg-success-subtle]="question.correctOption === 'D'">
                          <strong>D)</strong> {{ question.optionD }}
                          <i *ngIf="question.correctOption === 'D'" class="fas fa-check-circle text-success float-end"></i>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty State -->
          <div class="text-center py-4" *ngIf="selectedQuizQuestions.length === 0 && !quizLoading">
            <i class="fas fa-box-open text-muted" style="font-size: 3rem;"></i>
            <h6 class="mt-3 text-muted">No Questions Available</h6>
            <p class="text-muted">This quiz doesn't have any questions yet.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showCourseModal || showQuizViewModal" (click)="showCourseModal ? closeCourseModal() : closeQuizViewModal()"></div> 