<div class="enrollments-container">
  <!-- Header -->
  <div class="enrollments-header">
    <div class="header-title">
      <h2><i class="fa fa-graduation-cap"></i> Course Enrollments</h2>
      <p *ngIf="activeView === 'enrollment-management' && selectedRole === 'Learner'">Enroll students in courses</p>
      <p *ngIf="activeView === 'enrollment-management' && selectedRole === 'Instructor'">Assign instructors to courses</p>
      <p *ngIf="activeView === 'view-enrollments'">View and manage student enrollments</p>
      <p *ngIf="activeView === 'view-assignments'">View and manage instructor assignments</p>
    </div>
    
    <div class="header-actions">
      <button 
        *ngIf="activeView === 'enrollment-management'" 
        class="btn btn-primary" 
        (click)="openAddModal()" 
        [disabled]="isLoading">
        <i class="fa fa-plus"></i>
        {{ getActionDisplayName() }} {{ getRoleDisplayName() }}
      </button>
      
      <button 
        *ngIf="activeView === 'enrollment-management'" 
        class="btn btn-secondary" 
        (click)="openBulkModal()" 
        [disabled]="isLoading">
        <i class="fa fa-upload"></i>
        Bulk {{ getActionDisplayName() }}
      </button>
    </div>
  </div>

  <!-- Message Display -->
  <div *ngIf="message" class="message-container" [class]="'message-' + messageType">
    <i class="fa" [class.fa-check-circle]="messageType === 'success'" [class.fa-exclamation-triangle]="messageType === 'error'"></i>
    <span>{{ message }}</span>
    <button class="message-close" (click)="clearMessage()">
      <i class="fa fa-times"></i>
    </button>
  </div>

  <!-- View Content -->
  <div class="enrollments-content">
    
    <!-- Assignment Management (for enrollment-management view) -->
    <div *ngIf="activeView === 'enrollment-management'" class="assignment-form-section">
      <div class="form-instructions">
        <h3>
          <i class="fa" [class.fa-user-graduate]="selectedRole === 'Learner'" [class.fa-chalkboard-teacher]="selectedRole === 'Instructor'"></i>
          {{ getActionDisplayName() }} {{ getRoleDisplayName() }} to Course
        </h3>
        <p>Use the buttons above to {{ getActionDisplayName().toLowerCase() }} individual {{ getRoleDisplayName().toLowerCase() }}s or upload multiple assignments at once.</p>
      </div>
      
      <!-- Role Switcher -->
      <div class="role-switcher">
        <h4>Select Action:</h4>
        <div class="role-buttons">
          <button 
            class="btn" 
            [class.btn-primary]="selectedRole === 'Learner'" 
            [class.btn-outline]="selectedRole !== 'Learner'"
            (click)="selectedRole = 'Learner'; loadData(); loadAvailableUsers()">
            <i class="fa fa-user-graduate"></i>
            Enroll Students
          </button>
          <button 
            class="btn" 
            [class.btn-primary]="selectedRole === 'Instructor'" 
            [class.btn-outline]="selectedRole !== 'Instructor'"
            (click)="selectedRole = 'Instructor'; loadData(); loadAvailableUsers()">
            <i class="fa fa-chalkboard-teacher"></i>
            Assign Instructors
          </button>
        </div>
      </div>
      
              <!-- Quick Stats -->
        <div class="quick-stats">
          <div class="stat-card" (click)="setActiveView('view-enrollments')">
            <div class="stat-icon">
              <i class="fa fa-user-graduate"></i>
            </div>
            <div class="stat-info">
              <h4>{{ studentEnrollments.length || 0 }}</h4>
              <p>Student Enrollments</p>
              <small>Click to view list</small>
            </div>
          </div>
          
          <div class="stat-card" (click)="setActiveView('view-assignments')">
            <div class="stat-icon">
              <i class="fa fa-chalkboard-teacher"></i>
            </div>
            <div class="stat-info">
              <h4>{{ instructorAssignments.length || 0 }}</h4>
              <p>Instructor Assignments</p>
              <small>Click to view list</small>
            </div>
          </div>
        </div>
        
        <!-- Refresh Button -->
        <div class="refresh-section">
          <button class="btn btn-info" (click)="refreshData()" [disabled]="isLoading">
            <i class="fa fa-refresh" [class.fa-spin]="isLoading"></i>
            {{ isLoading ? 'Loading...' : 'Refresh Data' }}
          </button>
        </div>
    </div>

    <!-- Data Views (for view-enrollments and view-assignments) -->
    <div *ngIf="activeView === 'view-enrollments' || activeView === 'view-assignments'" class="data-view-section">
      
      <!-- Back Button and Search -->
      <div class="filters-section">
        <div class="filter-header">
          <button class="btn btn-secondary back-btn" (click)="setActiveView('enrollment-management')">
            <i class="fa fa-arrow-left"></i>
            Back to Enrollment Management
          </button>
          
          <div class="search-group">
            <label for="searchInput">Search:</label>
            <div class="search-input-container">
              <i class="fa fa-search search-icon"></i>
              <input 
                id="searchInput"
                type="text" 
                [(ngModel)]="searchTerm" 
                (input)="onSearchChange()"
                placeholder="Search by email or course..."
                class="form-control"
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Loading Spinner -->
      <div *ngIf="isLoading" class="loading-container">
        <div class="spinner"></div>
        <p>Loading {{ getRoleDisplayName().toLowerCase() }} data...</p>
      </div>

      <!-- Data Table -->
      <div *ngIf="!isLoading" class="table-container">
        <div *ngIf="filteredData.length === 0" class="no-data">
          <i class="fa fa-graduation-cap"></i>
          <h3>No {{ getRoleDisplayName() }}s Found</h3>
          <p>{{ searchTerm ? 'No data matches your search criteria.' : 'No ' + getRoleDisplayName().toLowerCase() + 's have been assigned yet.' }}</p>
        </div>

        <table *ngIf="filteredData.length > 0" class="data-table">
          <thead>
            <tr>
              <th>{{ getRoleDisplayName() }} Email</th>
              <th>Course Title</th>
              <th>Assigned Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let assignment of filteredData; trackBy: trackByEmail" class="data-row">
              <td class="email-cell">
                <div class="user-info">
                  <i class="fa" [class.fa-user-graduate]="selectedRole === 'Learner'" [class.fa-chalkboard-teacher]="selectedRole === 'Instructor'"></i>
                  <span>{{ assignment.userEmail }}</span>
                </div>
              </td>
              <td class="course-cell">
                <span class="course-title">{{ assignment.courseTitle }}</span>
              </td>
              <td class="date-cell">{{ formatDate(assignment.assignedDate) }}</td>
              <td class="status-cell">
                <span class="status-badge" [class]="assignment.isActive ? 'status-active' : 'status-inactive'">
                  {{ assignment.isActive ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="actions-cell">
                <button 
                  class="btn btn-small btn-info" 
                  (click)="openEditModal(assignment)" 
                  title="Edit Assignment">
                  <i class="fa fa-edit"></i>
                </button>
                <button 
                  class="btn btn-small btn-danger" 
                  (click)="openDeleteModal(assignment)" 
                  title="Delete Assignment">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Single Assignment Modal -->
<div class="modal-overlay" [class.active]="showAddModal" (click)="closeAddModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fa" [class.fa-user-graduate]="selectedRole === 'Learner'" [class.fa-chalkboard-teacher]="selectedRole === 'Instructor'"></i>
        {{ getActionDisplayName() }} {{ getRoleDisplayName() }}
      </h3>
      <button class="close-btn" (click)="closeAddModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="addSingleAssignment()" class="assignment-form">
        <div class="form-group">
          <label for="userEmail">{{ getRoleDisplayName() }} Email *</label>
          <select 
            id="userEmail"
            [(ngModel)]="singleAssignment.userEmail" 
            name="userEmail"
            class="form-control"
            required>
            <option value="">
              {{ availableUsers.length > 0 ? 'Select ' + getRoleDisplayName().toLowerCase() + '...' : 'No ' + getRoleDisplayName().toLowerCase() + 's available' }}
            </option>
            <option *ngFor="let user of availableUsers" [value]="user.email">
              {{ user.email }} {{ user.name ? '(' + user.name + ')' : '' }}
            </option>
          </select>
          <small class="form-help" *ngIf="availableUsers.length > 0">
            Select from {{ availableUsers.length }} available {{ getRoleDisplayName().toLowerCase() }}(s) in the system
          </small>
          <small class="form-help text-warning" *ngIf="availableUsers.length === 0">
            ⚠️ No {{ getRoleDisplayName().toLowerCase() }}s found. Please check your database or contact administrator.
          </small>
        </div>
        
        <div class="form-group">
          <label for="courseTitle">Course Title *</label>
          <input 
            id="courseTitle"
            type="text" 
            [(ngModel)]="singleAssignment.courseTitle" 
            name="courseTitle"
            class="form-control"
            placeholder="Enter course title"
            required
          >
        </div>
        
        <div class="modal-actions">
          <button type="submit" class="btn btn-success" [disabled]="isLoading">
            <i class="fa fa-save"></i>
            {{ isLoading ? (getActionDisplayName() + 'ing...') : (getActionDisplayName() + ' ' + getRoleDisplayName()) }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="closeAddModal()" [disabled]="isLoading">
            <i class="fa fa-times"></i>
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bulk Assignment Modal -->
<div class="modal-overlay" [class.active]="showBulkModal" (click)="closeBulkModal()">
  <div class="modal-content bulk-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fa fa-upload"></i>
        Bulk {{ getActionDisplayName() }} {{ getRoleDisplayName() }}s
      </h3>
      <button class="close-btn" (click)="closeBulkModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="bulk-instructions">
        <h4>Instructions:</h4>
        <p>Enter one assignment per line in the format: <strong>email, course title</strong></p>
        <p>Example:</p>
        <pre>student1@example.com, Introduction to Programming
student2@example.com, Advanced Mathematics
instructor@example.com, Web Development</pre>
      </div>
      
      <form (ngSubmit)="addBulkAssignments()" class="bulk-form">
        <div class="form-group">
          <label for="bulkText">Assignments Data *</label>
          <textarea 
            id="bulkText"
            [(ngModel)]="bulkText" 
            name="bulkText"
            class="form-control bulk-textarea"
            placeholder="Enter assignments (email, course title) - one per line"
            rows="8"
            required
          ></textarea>
        </div>
        
        <div class="modal-actions">
          <button type="submit" class="btn btn-success" [disabled]="isLoading">
            <i class="fa fa-upload"></i>
            {{ isLoading ? 'Processing...' : ('Bulk ' + getActionDisplayName()) }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="closeBulkModal()" [disabled]="isLoading">
            <i class="fa fa-times"></i>
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Assignment Modal -->
<div class="modal-overlay" [class.active]="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fa fa-edit"></i> Edit Assignment</h3>
      <button class="close-btn" (click)="closeEditModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="updateAssignment()" class="edit-form">
        <div class="form-group">
          <label for="editEmail">{{ getRoleDisplayName() }} Email</label>
          <input 
            id="editEmail"
            type="email" 
            [value]="editForm.userEmail" 
            class="form-control readonly"
            readonly
            title="Email cannot be changed"
          >
          <small class="form-help">Email address cannot be modified</small>
        </div>
        
        <div class="form-group">
          <label for="editCurrentCourse">Current Course</label>
          <input 
            id="editCurrentCourse"
            type="text" 
            [value]="editForm.courseTitle" 
            class="form-control readonly"
            readonly
            title="Current course assignment"
          >
        </div>
        
        <div class="form-group">
          <label for="editNewCourse">New Course Title *</label>
          <input 
            id="editNewCourse"
            type="text" 
            [(ngModel)]="editForm.newCourseTitle" 
            name="newCourseTitle"
            class="form-control"
            placeholder="Enter new course title"
            required
          >
        </div>
        
        <div class="modal-actions">
          <button type="submit" class="btn btn-success" [disabled]="isLoading">
            <i class="fa fa-save"></i>
            {{ isLoading ? 'Updating...' : 'Update Assignment' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()" [disabled]="isLoading">
            <i class="fa fa-times"></i>
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Assignment Modal -->
<div class="modal-overlay" [class.active]="showDeleteModal" (click)="closeDeleteModal()">
  <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fa fa-trash"></i> Delete Assignment</h3>
      <button class="close-btn" (click)="closeDeleteModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="delete-confirmation">
        <div class="warning-icon">
          <i class="fa fa-exclamation-triangle"></i>
        </div>
        <h4>Are you sure?</h4>
        <p>You are about to delete this assignment:</p>
        <div class="assignment-info" *ngIf="editAssignment">
          <strong>{{ editAssignment.userEmail }}</strong><br>
          <span>{{ editAssignment.courseTitle }}</span><br>
          <span class="role-info">Role: {{ getRoleDisplayName() }}</span>
        </div>
        <p class="warning-text">This action cannot be undone.</p>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-danger" (click)="deleteAssignment()" [disabled]="isLoading">
          <i class="fa fa-trash"></i>
          {{ isLoading ? 'Deleting...' : 'Delete Assignment' }}
        </button>
        <button class="btn btn-secondary" (click)="closeDeleteModal()" [disabled]="isLoading">
          <i class="fa fa-times"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>
</div> 