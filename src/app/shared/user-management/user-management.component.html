<div class="user-management-container">
  <!-- Header -->
  <div class="management-header">
    <div class="header-title">
      <h2><i class="fa fa-users"></i> User Management</h2>
      <p *ngIf="activeView === 'view-all'">View all users you have permission to see</p>
      <p *ngIf="activeView === 'register'">Register new users in the system</p>
      <p *ngIf="activeView === 'view-by-role'">Filter users by their specific roles</p>
      <p *ngIf="activeView === 'update'">Select a user to update their information</p>
      <p *ngIf="activeView === 'delete'">Select a user to remove from the system</p>
      <p *ngIf="activeView === 'toggle-status'">Activate or deactivate user accounts</p>
    </div>
    <button 
      *ngIf="canShowCreateButton()" 
      class="btn btn-primary" 
      (click)="openCreateModal()" 
      [disabled]="isLoading">
      <i class="fa fa-plus"></i>
      Add New User
    </button>
  </div>

  <!-- Message Display -->
  <div *ngIf="message" class="message-container" [class]="'message-' + messageType">
    <i class="fa" [class.fa-check-circle]="messageType === 'success'" [class.fa-exclamation-triangle]="messageType === 'error'"></i>
    <span>{{ message }}</span>
    <button class="message-close" (click)="clearMessage()">
      <i class="fa fa-times"></i>
    </button>
  </div>

  <!-- Filters and Search -->
  <div class="filters-section" *ngIf="activeView !== 'register'">
    <div class="filter-group" *ngIf="showRoleFilter">
      <label for="roleFilter">Filter by Role:</label>
      <select id="roleFilter" [(ngModel)]="selectedRole" (change)="onRoleChange()" class="form-control">
        <option *ngFor="let role of availableRoles" [value]="role">
          {{ getRoleDisplayName(role) }}
        </option>
      </select>
    </div>
    
    <div class="search-group">
      <label for="searchInput">Search Users:</label>
      <div class="search-input-container">
        <i class="fa fa-search search-icon"></i>
        <input 
          id="searchInput"
          type="text" 
          [(ngModel)]="searchTerm" 
          (input)="onSearchChange()"
          placeholder="Search by name, email, or phone..."
          class="form-control"
        >
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Loading users...</p>
  </div>

  <!-- Users Table -->
  <div *ngIf="!isLoading && activeView !== 'register'" class="table-container">
    <div *ngIf="filteredUsers.length === 0" class="no-users">
      <i class="fa fa-users"></i>
      <h3>No Users Found</h3>
      <p>{{ searchTerm ? 'No users match your search criteria.' : 'No users available for the selected role.' }}</p>
    </div>

    <table *ngIf="filteredUsers.length > 0" class="users-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Phone</th>
          <th>Role</th>
          <th>Created</th>
          <th>Status</th>
          <th *ngIf="canShowEditButton() || canShowDeleteButton() || canShowToggleButton()">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers; trackBy: trackByUserId" class="user-row">
          <td class="user-id">#{{ getUserId(user) }}</td>
          <td class="user-name">
            <div class="name-cell">
              <div class="user-avatar">
                <i class="fa fa-user"></i>
              </div>
              <span>{{ user.name }}</span>
            </div>
          </td>
          <td class="user-email">{{ user.email }}</td>
          <td class="user-phone">{{ user.phoneNumber }}</td>
          <td class="user-role">
            <span class="role-badge" [class]="getRoleColor(user.role)">
              {{ getRoleDisplayName(user.role) }}
            </span>
          </td>
          <td class="user-created">{{ formatDate(user.createdAt) }}</td>
          <td class="user-status">
            <span class="status-badge" [class]="user.isActive !== false ? 'status-active' : 'status-inactive'">
              {{ user.isActive !== false ? 'Active' : 'Inactive' }}
            </span>
          </td>
          <td class="user-actions" *ngIf="canShowEditButton() || canShowDeleteButton() || canShowToggleButton()">
            <button 
              *ngIf="canShowEditButton()" 
              class="btn btn-small btn-info" 
              (click)="openEditModal(user)" 
              title="Edit User">
              <i class="fa fa-edit"></i>
            </button>
            <button 
              *ngIf="canShowDeleteButton()" 
              class="btn btn-small btn-danger" 
              (click)="openDeleteModal(user)" 
              title="Delete User">
              <i class="fa fa-trash"></i>
            </button>
            <button 
              *ngIf="canShowToggleButton()" 
              class="btn btn-small" 
              [class.btn-success]="user.isActive === false" 
              [class.btn-warning]="user.isActive !== false"
              (click)="openToggleModal(user)" 
              [title]="user.isActive !== false ? 'Deactivate User' : 'Activate User'">
              <i class="fa" [class.fa-toggle-on]="user.isActive !== false" [class.fa-toggle-off]="user.isActive === false"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Register User View -->
  <div *ngIf="activeView === 'register' && !isLoading" class="register-view">
    <div class="register-instructions">
      <h3><i class="fa fa-user-plus"></i> Register New User</h3>
      <p>Fill in the form below to create a new user account. All fields marked with * are required.</p>
    </div>
    
    <form (ngSubmit)="createUser()" class="register-form">
      <div class="form-row">
        <div class="form-group">
          <label for="registerName">Full Name *</label>
          <input 
            id="registerName"
            type="text" 
            [(ngModel)]="createForm.name" 
            name="name"
            class="form-control"
            placeholder="Enter full name"
            required
          >
        </div>
        
        <div class="form-group">
          <label for="registerEmail">Email Address *</label>
          <input 
            id="registerEmail"
            type="email" 
            [(ngModel)]="createForm.email" 
            name="email"
            class="form-control"
            placeholder="Enter email address"
            required
          >
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label for="registerPhone">Phone Number *</label>
          <input 
            id="registerPhone"
            type="tel" 
            [(ngModel)]="createForm.phoneNumber" 
            name="phoneNumber"
            class="form-control"
            placeholder="Enter phone number"
            required
          >
        </div>
        
        <div class="form-group">
          <label for="registerRole">Role *</label>
          <select 
            id="registerRole"
            [(ngModel)]="createForm.role" 
            name="role"
            class="form-control"
            required
          >
            <option *ngFor="let role of availableRoles" [value]="role">
              {{ getRoleDisplayName(role) }}
            </option>
          </select>
        </div>
      </div>
      
      <div class="form-group">
        <label for="registerPassword">Password *</label>
        <div class="password-input-group">
          <input 
            id="registerPassword"
            type="text" 
            [(ngModel)]="createForm.password" 
            name="password"
            class="form-control"
            placeholder="Enter password"
            required
          >
          <button type="button" class="btn btn-secondary btn-small" (click)="generatePassword()">
            <i class="fa fa-refresh"></i> Generate
          </button>
        </div>
        <small class="form-help">Password will be sent to the user's email address</small>
      </div>
      
      <div class="register-actions">
        <button type="submit" class="btn btn-success btn-large" [disabled]="isLoading">
          <i class="fa fa-save"></i>
          {{ isLoading ? 'Creating...' : 'Create User' }}
        </button>
        <button type="button" class="btn btn-secondary btn-large" (click)="activeView = 'view-all'; loadUsers()">
          <i class="fa fa-list"></i>
          View All Users
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Create User Modal -->
<div class="modal-overlay" [class.active]="showCreateModal" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fa fa-user-plus"></i> Create New User</h3>
      <button class="close-btn" (click)="closeCreateModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="createUser()" class="create-form">
        <div class="form-row">
          <div class="form-group">
            <label for="createName">Full Name *</label>
            <input 
              id="createName"
              type="text" 
              [(ngModel)]="createForm.name" 
              name="name"
              class="form-control"
              placeholder="Enter full name"
              required
            >
          </div>
          
          <div class="form-group">
            <label for="createEmail">Email Address *</label>
            <input 
              id="createEmail"
              type="email" 
              [(ngModel)]="createForm.email" 
              name="email"
              class="form-control"
              placeholder="Enter email address"
              required
            >
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="createPhone">Phone Number *</label>
            <input 
              id="createPhone"
              type="tel" 
              [(ngModel)]="createForm.phoneNumber" 
              name="phoneNumber"
              class="form-control"
              placeholder="Enter phone number"
              required
            >
          </div>
          
          <div class="form-group">
            <label for="createRole">Role *</label>
            <select 
              id="createRole"
              [(ngModel)]="createForm.role" 
              name="role"
              class="form-control"
              required
            >
              <option *ngFor="let role of availableRoles" [value]="role">
                {{ getRoleDisplayName(role) }}
              </option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label for="createPassword">Password *</label>
          <div class="password-input-group">
            <input 
              id="createPassword"
              type="text" 
              [(ngModel)]="createForm.password" 
              name="password"
              class="form-control"
              placeholder="Enter password"
              required
            >
            <button type="button" class="btn btn-secondary btn-small" (click)="generatePassword()">
              <i class="fa fa-refresh"></i> Generate
            </button>
          </div>
          <small class="form-help">Password will be sent to the user's email address</small>
        </div>
        
        <div class="modal-actions">
          <button type="submit" class="btn btn-success" [disabled]="isLoading">
            <i class="fa fa-save"></i>
            {{ isLoading ? 'Creating...' : 'Create User' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="closeCreateModal()" [disabled]="isLoading">
            <i class="fa fa-times"></i>
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal-overlay" [class.active]="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fa fa-edit"></i> Edit User</h3>
      <button class="close-btn" (click)="closeEditModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <form (ngSubmit)="updateUser()" class="edit-form">
        <div class="form-group">
          <label for="editEmail">Email Address</label>
          <input 
            id="editEmail"
            type="email" 
            [value]="editForm.email" 
            class="form-control readonly"
            readonly
            title="Email cannot be changed"
          >
          <small class="form-help">Email address cannot be modified</small>
        </div>
        
        <div class="form-group">
          <label for="editName">Full Name *</label>
          <input 
            id="editName"
            type="text" 
            [(ngModel)]="editForm.name" 
            name="name"
            class="form-control"
            placeholder="Enter full name"
            required
          >
        </div>
        
        <div class="form-group">
          <label for="editPhone">Phone Number *</label>
          <input 
            id="editPhone"
            type="tel" 
            [(ngModel)]="editForm.phonenumber" 
            name="phonenumber"
            class="form-control"
            placeholder="Enter phone number"
            required
          >
        </div>
        
        <div class="modal-actions">
          <button type="submit" class="btn btn-success" [disabled]="isLoading">
            <i class="fa fa-save"></i>
            {{ isLoading ? 'Updating...' : 'Update User' }}
          </button>
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()" [disabled]="isLoading">
            <i class="fa fa-times"></i>
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete User Modal -->
<div class="modal-overlay" [class.active]="showDeleteModal" (click)="closeDeleteModal()">
  <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fa fa-trash"></i> Delete User</h3>
      <button class="close-btn" (click)="closeDeleteModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="delete-confirmation">
        <div class="warning-icon">
          <i class="fa fa-exclamation-triangle"></i>
        </div>
        <h4>Are you sure?</h4>
        <p>You are about to delete the user:</p>
        <div class="user-info" *ngIf="selectedUser">
          <strong>{{ selectedUser.name }}</strong><br>
          <span>{{ selectedUser.email }}</span><br>
          <span class="role-badge" [class]="getRoleColor(selectedUser.role)">
            {{ getRoleDisplayName(selectedUser.role) }}
          </span>
        </div>
        <p class="warning-text">This action cannot be undone.</p>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-danger" (click)="deleteUser()" [disabled]="isLoading">
          <i class="fa fa-trash"></i>
          {{ isLoading ? 'Deleting...' : 'Delete User' }}
        </button>
        <button class="btn btn-secondary" (click)="closeDeleteModal()" [disabled]="isLoading">
          <i class="fa fa-times"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>
</div> 

<!-- Toggle User Status Modal -->
<div class="modal-overlay" [class.active]="showToggleModal" (click)="closeToggleModal()">
  <div class="modal-content toggle-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fa" [class.fa-toggle-on]="toggleAction === 'activate'" [class.fa-toggle-off]="toggleAction === 'deactivate'"></i>
        {{ toggleAction === 'activate' ? 'Activate' : 'Deactivate' }} User
      </h3>
      <button class="close-btn" (click)="closeToggleModal()">
        <i class="fa fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <div class="toggle-confirmation">
        <div class="toggle-icon">
          <i class="fa fa-user" [class.text-success]="toggleAction === 'activate'" [class.text-warning]="toggleAction === 'deactivate'"></i>
        </div>
        <h4>{{ toggleAction === 'activate' ? 'Activate' : 'Deactivate' }} User Account?</h4>
        <p *ngIf="toggleAction === 'activate'">This will allow the user to access the system again.</p>
        <p *ngIf="toggleAction === 'deactivate'">This will prevent the user from accessing the system.</p>
        
        <div class="user-info" *ngIf="selectedUser">
          <strong>{{ selectedUser.name }}</strong><br>
          <span>{{ selectedUser.email }}</span><br>
          <span class="role-badge" [class]="getRoleColor(selectedUser.role)">
            {{ getRoleDisplayName(selectedUser.role) }}
          </span><br>
          <span class="status-badge" [class]="selectedUser.isActive !== false ? 'status-active' : 'status-inactive'">
            Current Status: {{ selectedUser.isActive !== false ? 'Active' : 'Inactive' }}
          </span>
        </div>
      </div>
      
      <div class="modal-actions">
        <button 
          class="btn" 
          [class.btn-success]="toggleAction === 'activate'" 
          [class.btn-warning]="toggleAction === 'deactivate'"
          (click)="toggleUserStatus()" 
          [disabled]="isLoading">
          <i class="fa" [class.fa-toggle-on]="toggleAction === 'activate'" [class.fa-toggle-off]="toggleAction === 'deactivate'"></i>
          {{ isLoading ? (toggleAction === 'activate' ? 'Activating...' : 'Deactivating...') : (toggleAction === 'activate' ? 'Activate User' : 'Deactivate User') }}
        </button>
        <button class="btn btn-secondary" (click)="closeToggleModal()" [disabled]="isLoading">
          <i class="fa fa-times"></i>
          Cancel
        </button>
      </div>
    </div>
  </div>
</div> 